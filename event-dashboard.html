<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Donor Dashboard | HopePlates</title>
  <link rel="stylesheet" href="style.css">
  <style>
    .match-suggestions {
      margin-top: 1rem;
      padding: 1rem;
      background: #f0f9ff;
      border-radius: 12px;
      border: 1px solid #bae6fd;
    }
    .match-item {
      padding: 0.75rem;
      margin: 0.5rem 0;
      background: white;
      border-radius: 8px;
      border-left: 3px solid var(--primary);
    }
    .match-badge {
      display: inline-block;
      padding: 0.25rem 0.5rem;
      border-radius: 6px;
      font-size: 0.75rem;
      font-weight: 600;
      margin-left: 0.5rem;
    }
    .badge-high { background: #dcfce7; color: #166534; }
    .badge-medium { background: #fef3c7; color: #92400e; }
    .role-label {
      font-size: 0.85rem;
      color: var(--text-muted);
      margin-bottom: 1rem;
    }
  </style>
</head>
<body>

<header class="dashboard-header">
  <h2>Food Donor Dashboard</h2>
  <p class="role-label">Logged in as: <strong id="userEmail">donor@test.com</strong></p>
</header>

<main class="dashboard grid-2">

  <!-- ADD SURPLUS FOOD -->
  <div class="card">
    <h3>Add Surplus Food</h3>

    <form class="form" id="donorForm">

      <div class="form-group">
        <label>Event Space Name</label>
        <input type="text" name="eventSpaceName" placeholder="Wedding Hall / Event Venue" required>
      </div>

      <div class="form-group">
        <label>Contact Person Name</label>
        <input type="text" name="contactPerson" placeholder="Single point of communication" required>
      </div>

      <div class="form-group">
        <label>Contact Number</label>
        <input type="tel" name="contactNumber" placeholder="10-digit mobile number" required>
      </div>

      <div class="form-group">
        <label>Food Type</label>
        <select name="foodType" required>
          <option value="">Select</option>
          <option>Veg</option>
          <option>Non-Veg</option>
          <option>Mixed</option>
        </select>
      </div>

      <div class="form-group">
        <label>Food Category</label>
        <select name="foodCategory" required>
          <option value="">Select</option>
          <option>Cooked Meal</option>
          <option>Snacks</option>
          <option>Packed Food</option>
        </select>
      </div>

      <div class="form-group">
        <label>Quantity Available (People)</label>
        <input type="number" name="quantity" placeholder="Number of people it can serve" required>
      </div>

      <div class="form-group">
        <label>Time of Preparation</label>
        <input type="time" name="preparationTime" required>
      </div>

      <div class="form-group">
        <label>Pickup Time Window</label>
        <input type="text" name="pickupTime" placeholder="Eg: 7:30 PM - 8:30 PM" required>
      </div>

      <div class="form-group">
        <label>Location / Area</label>
        <input type="text" name="location" placeholder="Area / Landmark" required>
      </div>

      <div class="form-group">
        <label>Latitude (GPS Coordinate)</label>
        <input type="number" name="latitude" step="0.000001" placeholder="e.g., 13.0827" required>
      </div>

      <div class="form-group">
        <label>Longitude (GPS Coordinate)</label>
        <input type="number" name="longitude" step="0.000001" placeholder="e.g., 80.2707" required>
      </div>

      <button type="button" class="btn secondary full" onclick="getLocation()" style="margin-bottom: 1rem;">
        üìç Use My Current Location
      </button>

      <button type="submit" class="btn primary full">Submit Donation</button>
    </form>

    <div id="matchSuggestions" class="match-suggestions" style="display: none;">
      <h4 style="margin-bottom: 0.5rem;">üéØ Matched NGOs</h4>
      <div id="matchList"></div>
    </div>
  </div>

  <!-- STATUS OVERVIEW -->
  <div class="card">
    <h3>My Donations Status</h3>
    <ul class="status-list" id="statusList"></ul>
    
    <div style="margin-top: 2rem; padding: 1.5rem; background: #f0fdf4; border-radius: 12px;">
      <h4 style="color: var(--primary); margin-bottom: 0.75rem;">üìä My Impact</h4>
      <p><strong id="totalDonations">0</strong> donations made</p>
      <p><strong id="totalPeople">0</strong> people served</p>
      <p><strong id="completedRate">0%</strong> completion rate</p>
    </div>
  </div>

</main>

<script>
const form = document.getElementById('donorForm');
const statusList = document.getElementById('statusList');
const matchSuggestions = document.getElementById('matchSuggestions');
const matchList = document.getElementById('matchList');

// Get user's current location
function getLocation() {
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(
      (position) => {
        form.latitude.value = position.coords.latitude.toFixed(6);
        form.longitude.value = position.coords.longitude.toFixed(6);
        alert('‚úÖ Location captured successfully!');
      },
      (error) => {
        alert('‚ùå Unable to get location. Please enter manually.');
      }
    );
  } else {
    alert('‚ùå Geolocation not supported by this browser.');
  }
}

// Load donor events
async function loadDonorEvents() {
  try {
    const res = await fetch('/api/donor');
    const donors = await res.json();

    statusList.innerHTML = '';

    if (donors.length === 0) {
      statusList.innerHTML = '<li style="color: var(--text-muted);">No donations yet</li>';
      return;
    }

    let totalPeople = 0;
    let completed = 0;

    donors.forEach(donor => {
      let icon =
        donor.status === 'Delivered' ? '‚úÖ' :
        donor.status === 'Picked Up' ? 'üöö' :
        donor.status === 'Accepted' ? 'üîµ' : 'üü°';

      if (donor.status === 'Delivered') completed++;
      totalPeople += parseInt(donor.quantity) || 0;

      const li = document.createElement('li');
      li.textContent = `${icon} ${donor.eventSpaceName} ‚Äî ${donor.quantity} people (${donor.foodType}) - ${donor.status}`;
      statusList.appendChild(li);
    });

    // Update impact stats
    document.getElementById('totalDonations').textContent = donors.length;
    document.getElementById('totalPeople').textContent = totalPeople;
    document.getElementById('completedRate').textContent = 
      donors.length > 0 ? Math.round((completed / donors.length) * 100) + '%' : '0%';

  } catch (error) {
    console.error('Error loading donations:', error);
  }
}

// Submit donor form
form.addEventListener('submit', async (e) => {
  e.preventDefault();

  const formData = new FormData(form);
  const donor = {};
  
  formData.forEach((value, key) => {
    donor[key] = value;
  });

  // Convert coordinates to numbers
  donor.latitude = parseFloat(donor.latitude);
  donor.longitude = parseFloat(donor.longitude);

  try {
    const res = await fetch('/api/donor', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(donor)
    });

    const result = await res.json();

    if (result.success) {
      alert('‚úÖ Donation submitted successfully!');
      
      // Show matched NGOs
      if (result.suggestedNGOs && result.suggestedNGOs.length > 0) {
        matchList.innerHTML = '';
        result.suggestedNGOs.forEach(ngo => {
          const matchItem = document.createElement('div');
          matchItem.className = 'match-item';
          
          const badge = ngo.reliability >= 80 ? 'badge-high' : 'badge-medium';
          const badgeText = ngo.reliability >= 80 ? 'Highly Reliable' : 'Reliable';
          
          matchItem.innerHTML = `
            <strong>${ngo.name}</strong>
            <span class="match-badge ${badge}">${badgeText}</span>
            <br>
            <small>üìç ${ngo.distance} km away ‚Ä¢ ‚≠ê ${ngo.reliability}% reliability</small>
          `;
          matchList.appendChild(matchItem);
        });
        matchSuggestions.style.display = 'block';
      }

      form.reset();
      loadDonorEvents();
      
      // Hide suggestions after 10 seconds
      setTimeout(() => {
        matchSuggestions.style.display = 'none';
      }, 10000);
    }
  } catch (error) {
    console.error('Error submitting donation:', error);
    alert('‚ùå Error submitting donation. Please try again.');
  }
});

// Initial load
loadDonorEvents();
setInterval(loadDonorEvents, 5000);
</script>

</body>
</html>
